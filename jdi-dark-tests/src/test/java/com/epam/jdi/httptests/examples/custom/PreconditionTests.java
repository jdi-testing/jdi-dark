package com.epam.jdi.httptests.examples.custom;

import com.epam.http.response.RestResponse;
import com.epam.jdi.dto.Board;
import com.epam.jdi.dto.Organization;
import com.epam.jdi.services.TrelloService;
import org.apache.commons.csv.*;
import org.testng.Assert;
import org.testng.annotations.*;

import java.io.*;
import java.nio.file.*;
import java.time.LocalDateTime;
import java.util.ArrayList;

import static com.epam.http.requests.RequestDataFactory.pathParams;
import static com.epam.http.requests.RequestDataFactory.body;
import static com.epam.http.requests.ServiceInit.init;
import static com.epam.jdi.httptests.utils.TrelloDataGenerator.generateOrganization;
import static java.lang.String.format;
import static org.hamcrest.core.IsEqual.equalTo;

public class PreconditionTests {

    public static final String CSV_DATA_FILE = "src/test/resources/testWithPreconditions.csv";
    private ArrayList<String> createdBoardsId = new ArrayList<String>();
    private static String newOrgId;

    @DataProvider(name = "createNewBoards")
    public static Object[][] createNewBoards() {
        return new Object[][]{
                {"Board B1-" + LocalDateTime.now()},
                {"Board B2-" + LocalDateTime.now()},
                {"Board B3-" + LocalDateTime.now()}
        };
    }

    @DataProvider(name = "dataProviderFromCSV")
    public static Object[] dataProviderFromCSV() throws IOException {
        Reader in = new FileReader(CSV_DATA_FILE);
        Iterable<CSVRecord> records = CSVFormat.DEFAULT
                .withHeader("id", "name", "shortUrl", "url")
                .parse(in);
        ArrayList<Object[]> dataList = new ArrayList<>();
        for (CSVRecord record : records) {
            dataList.add(new Object[]{record.get(0), record.get(1), record.get(2), record.get(3)});
        }
        return dataList.toArray(new Object[dataList.size()][]);
    }

    @BeforeClass
    public void initService() throws IOException {
        new FileWriter(CSV_DATA_FILE, false).close();

        // create Organization as we will get a error during Board creation in case of zero organizations
        Organization org = generateOrganization();
        Organization newOrg = getTrelloService().createOrganization(org);
        newOrgId = newOrg.id;
    }

    @Test(dataProvider = "createNewBoards")
    public void createNewBoardTest(String boardName) throws IOException {
        RestResponse response = getTrelloService().boardsPost.call(body(format("{\"name\": \"%s\"}", boardName)));
        response.isOk().body("name", equalTo(boardName));
        Board board = response.getRaResponse().as(Board.class);
        writeToCSV(board);
    }

    @Test(dataProvider = "dataProviderFromCSV")
    public void getBoardTestWithRequestData(String boardId, String expectedName, String expectedShortUrl, String expectedUrl) {
        getTrelloService().getBoardById.call(pathParams().add("board_id", boardId))
                .isOk().assertThat().body("name", equalTo(expectedName))
                .body("shortUrl", equalTo(expectedShortUrl))
                .body("url", equalTo(expectedUrl));
    }

    @Test(dataProvider = "dataProviderFromCSV")
    public void getBoardTest(String boardId, String expectedName, String expectedShortUrl, String expectedUrl) {
        Board gotBoard = getTrelloService().getBoard(boardId);
        Assert.assertEquals(gotBoard.name, expectedName, "Actual Board Name doesn't correspond expected");
        Assert.assertEquals(gotBoard.shortUrl, expectedShortUrl, "Actual Board ShortUrl doesn't correspond expected");
        Assert.assertEquals(gotBoard.url, expectedUrl, "Actual Board URL doesn't correspond expected");
    }

    private void writeToCSV(Board board) throws IOException {
        Writer writer = Files.newBufferedWriter(Paths.get(CSV_DATA_FILE), StandardOpenOption.APPEND, StandardOpenOption.CREATE);
        CSVPrinter printer = CSVFormat.EXCEL.print(writer);
        printer.printRecord(board.id, board.name, board.shortUrl, board.url);
        printer.flush();
        writer.close();
    }

    @AfterClass
    public void clearBoards() {
        TrelloService trello = getTrelloService();

        createdBoardsId.forEach(trello::deleteBoard);

        if (newOrgId != null) {
            trello.deleteOrg(newOrgId);
        }
    }

    private TrelloService getTrelloService() {
        return init(TrelloService.class);
    }
}
